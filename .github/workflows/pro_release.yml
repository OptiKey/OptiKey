name: Optikey Pro - Build, Sign, and Release

env:
  INSTALLER_VERSION: "4.2.0"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-sign-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Output github.ref to help debug when no matching Release tag is found
      - name: Print ref
        run: echo "github.ref is ${{ github.ref }}"
        
      # Restore against the solution so the classic ./packages folder is populated and HintPath references resolve.
      - name: NuGet restore (packages.config)
        shell: pwsh
        run: |
          nuget restore .\OptiKeyDeployment.sln -NonInteractive

      # Build the unsigned application
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build unsigned application (.NET Framework 4.6)
        run: |
          msbuild OptiKeyDeployment.sln /m /t:Rebuild /p:Configuration=Release /p:Platform=x64

      # ============================================================
      # STAGE 1: Sign Application EXE
      # ============================================================

      # Upload unsigned application executable
      - name: Upload unsigned application EXE
        id: upload-unsigned-app
        uses: actions/upload-artifact@v4
        with:
          name: optikey-pro-app-unsigned
          path: src/JuliusSweetland.OptiKey.Pro/bin/x64/Release/OptikeyPro.exe
          if-no-files-found: error

      # Submit application EXE to SignPath (Stage 1)
      - name: Submit application EXE for signing (Stage 1)
        id: sign-application
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '1f9940a3-1cdf-4429-a544-76ee316b7255'
          project-slug: 'OptiKey'
          artifact-configuration-slug: 'OptikeyProApp'
          signing-policy-slug: 'test-signing'
          github-artifact-id: '${{ steps.upload-unsigned-app.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: 'app-signed'

      # Copy signed EXE back to build output
      - name: Copy signed EXE to build output
        shell: pwsh
        run: |
          $releaseDir = "src\JuliusSweetland.OptiKey.Pro\bin\x64\Release"
          Write-Host "Copying signed OptikeyPro.exe to $releaseDir"
          Copy-Item "app-signed\OptikeyPro.exe" "$releaseDir\OptikeyPro.exe" -Force

          # Verify signature
          $sig = Get-AuthenticodeSignature "$releaseDir\OptikeyPro.exe"
          Write-Host "Application signature status: $($sig.Status)"

      # ============================================================
      # STAGE 2: Build and Sign Installer
      # ============================================================

      # Setup Advanced Installer
      - name: Setup Advanced Installer
        uses: caphyon/advinst-github-action@main
        with:
          advinst-version: '21.4'
          advinst-license: ${{ secrets.ADVINST_LICENSE_KEY }}
          advinst-enable-automation: 'true'
          aip-commands: |
            SetVersion $INSTALLER_VERSION

      # Build installer with signed application EXE
      - name: Build installer with signed EXE
        shell: pwsh
        run: |
          # Set repository path
          $repoPath = Join-Path ${{ github.workspace }} "installer"
          Write-Host "Setting repository path to: $repoPath"
          AdvancedInstaller.com /SetRepositoryPath "$repoPath"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to set repository path"
          }

          # Build installer
          Write-Host "Building OptiKeyPro installer with signed application..."
          AdvancedInstaller.com /build "${{ github.workspace }}\installer\OptiKeyPro.aip"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to build OptiKeyPro installer"
          }
          Write-Host "Installer build completed successfully"

      # Upload unsigned installer (contains signed app EXE)
      - name: Upload unsigned installer
        id: upload-unsigned-installer
        uses: actions/upload-artifact@v4
        with:
          name: optikey-pro-installer-unsigned
          path: installer/SetupFiles/OptiKeyPro.exe
          if-no-files-found: error

      # Submit installer to SignPath (Stage 2)
      - name: Submit installer for signing (Stage 2)
        id: sign-installer
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '1f9940a3-1cdf-4429-a544-76ee316b7255'
          project-slug: 'OptiKey'
          artifact-configuration-slug: 'OptikeyProInstaller'
          signing-policy-slug: 'test-signing'
          github-artifact-id: '${{ steps.upload-unsigned-installer.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: 'installer-signed'

      # Upload the signed installer as a GitHub artifact
      - name: Upload signed installer
        uses: actions/upload-artifact@v4
        with:
          name: optikey-pro-installer-signed
          path: installer-signed/OptiKeyPro.exe
          if-no-files-found: error

      # Verify final installer signature
      - name: Verify installer signature
        shell: pwsh
        run: |
          $sig = Get-AuthenticodeSignature "installer-signed\OptiKeyPro.exe"
          Write-Host "Installer signature status: $($sig.Status)"

      # Create a GitHub release with the signed installer (only for tagged releases)
      - name: Publish signed installer to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: signed-installer/OptiKeyPro.exe
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
