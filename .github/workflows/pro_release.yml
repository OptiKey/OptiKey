name: Optikey Pro - Build, Sign, and Release

env:
  INSTALLER_VERSION: "4.2.0"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-sign-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Restore against the solution so the classic ./packages folder is populated and HintPath references resolve.
      - name: NuGet restore (packages.config)
        shell: pwsh
        run: |
          nuget restore .\OptiKeyDeployment.sln -NonInteractive

      # Restore SDK-style projects (like InstallerTranslations) to generate project.assets.json
      - name: Dotnet restore (SDK-style projects)
        run: |
          dotnet restore .\OptiKeyDeployment.sln

      # Build the unsigned application
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build unsigned application (.NET Framework 4.6)
        run: |
          msbuild OptiKeyDeployment.sln /m /t:Rebuild /p:Configuration=Release /p:Platform=x64

      # Build the unsigned Advanced Installer project
      - name: Setup Advanced Installer
        uses: caphyon/advinst-github-action@main
        with:
          advinst-version: '21.4'
          advinst-license: ${{ secrets.ADVINST_LICENSE_KEY }}
          advinst-enable-automation: 'true'
          aip-commands: |
            SetVersion $INSTALLER_VERSION

      - name: Configure Advanced Installer Repository Path and Build
        shell: pwsh
        run: |
          # Set repository path
          $repoPath = Join-Path ${{ github.workspace }} "installer"
          Write-Host "Setting repository path to: $repoPath"
          AdvancedInstaller.com /SetRepositoryPath "$repoPath"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to set repository path"
          }

          # Build installer
          Write-Host "Building OptiKeyPro installer..."
          AdvancedInstaller.com /build "${{ github.workspace }}\installer\OptiKeyPro.aip"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to build OptiKeyPro installer"
          }
          Write-Host "Build completed successfully"

      # Upload the unsigned installer to GitHub artifacts
      - name: Upload unsigned installer
        id: upload-unsigned-artifact
        uses: actions/upload-artifact@v4
        with:
          name: optikey-pro-installer-unsigned
          path: installer/SetupFiles/OptiKeyPro.exe
          if-no-files-found: error

      # Submit the installer to SignPath for code signing
      - name: Submit signing request to SignPath
        id: submit-signing-request
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '1f9940a3-1cdf-4429-a544-76ee316b7255'
          project-slug: 'OptiKey'
          artifact-configuration-slug: 'OptikeyPro'
          signing-policy-slug: 'test-signing'
          github-artifact-id: '${{ steps.upload-unsigned-artifact.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: 'signed-installer'

      # Upload the signed installer as a GitHub artifact
      - name: Upload signed installer
        uses: actions/upload-artifact@v4
        with:
          name: optikey-pro-installer-signed
          path: signed-installer/OptiKeyPro.exe
          if-no-files-found: error

      # Create a GitHub release with the signed installer (only for tagged releases)
      - name: Publish signed installer to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: signed-installer/OptiKeyPro.exe
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
